<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ë©´ ê´€ë¦¬ í”„ë¡œê·¸ë¨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .section-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .section-card:hover {
            transform: translateY(-2px);
        }
        .breathing-circle {
            width: 150px;
            height: 150px;
            background-color: #3b82f6;
            border-radius: 50%;
            margin: 20px auto;
            opacity: 0.8;
            transition: transform 6s ease-in-out, background-color 0.5s ease;
        }
        .breathing-circle.breathing {
            animation: breathe 10s infinite;
        }
        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
                background-color: #3b82f6;
            }
            40% {
                transform: scale(1.2);
                background-color: #10b981;
            }
            60% {
                transform: scale(1.1);
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-8 text-center">ğŸŒ™ ìˆ˜ë©´ ìµœì í™” ë„ìš°ë¯¸</h1>

        <!-- ì¸ì¦ ë° ë¡œë”© ìƒíƒœ í‘œì‹œ -->
        <div id="authStatus" class="mb-4 text-center text-sm text-gray-500">
            ì¸ì¦ ì¤€ë¹„ ì¤‘...
        </div>

        <!-- REM ìˆ˜ë©´ ê³„ì‚°ê¸° (ê¸°ì¡´ ì¡°ê±´ 1) -->
        <div class="section-card mb-8">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">1. ìµœì  ìˆ˜ë©´ ì‹œê°„ ê³„ì‚°ê¸° (REM ì‚¬ì´í´)</h2>
            <p class="text-sm text-gray-600 mb-4">ìˆ˜ë©´ì€ ì•½ 90ë¶„ ì£¼ê¸°ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ì ë“œëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„(í‰ê·  14ë¶„)ì„ í¬í•¨í•˜ì—¬ ìµœì ì˜ ìˆ˜ë©´ ì‹œê°„ì„ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.</p>

            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-1">
                    <label for="calcTime" class="block text-sm font-medium text-gray-700">ì‹œê°„ ì…ë ¥</label>
                    <input type="time" id="calcTime" value="07:00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex-1">
                    <label for="calcType" class="block text-sm font-medium text-gray-700">ê³„ì‚° ê¸°ì¤€</label>
                    <select id="calcType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="wake">ì¼ì–´ë‚˜ì•¼ í•  ì‹œê°„</option>
                        <option value="sleep">ìë ¤ê³  í•˜ëŠ” ì‹œê°„</option>
                    </select>
                </div>
            </div>

            <button onclick="calculateSleepCycles()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-200/50">
                ìµœì  ì‹œê°„ ê³„ì‚°í•˜ê¸°
            </button>

            <div id="calcResult" class="mt-4 p-3 bg-indigo-50 rounded-lg text-indigo-800 font-medium">
                ê³„ì‚° ê¸°ì¤€ì„ ì„ íƒí•˜ê³  ì‹œê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- New Section: ìˆ˜ë©´ ìœ„ìƒ ìŠµê´€ ê¸°ë¡ (ì¶”ê°€ ê¸°ëŠ¥) -->
            <div class="section-card">
                <h2 class="text-2xl font-bold text-teal-700 mb-4">2. ìˆ˜ë©´ ìœ„ìƒ ìŠµê´€ ê¸°ë¡ (NEW)</h2>
                <p class="text-sm text-gray-600 mb-4">ìˆ˜ë©´ì˜ ì§ˆì„ ë†’ì´ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ìŠµê´€ë“¤ì„ ê¸°ë¡í•˜ì—¬ ê´€ë¦¬í•˜ì„¸ìš”.</p>

                <div class="space-y-3" id="hygieneChecklist">
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <label for="checkCaffeine" class="text-sm font-medium text-gray-700 flex-1">ì˜¤í›„ 2ì‹œ ì´í›„ ì¹´í˜ì¸ X</label>
                        <input type="checkbox" id="checkCaffeine" class="form-checkbox h-5 w-5 text-teal-600 rounded focus:ring-teal-500">
                    </div>
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <label for="checkExercise" class="text-sm font-medium text-gray-700 flex-1">ë‚®ì— ì¶©ë¶„í•œ ìš´ë™ (ì·¨ì¹¨ 3ì‹œê°„ ì „ ì™„ë£Œ)</label>
                        <input type="checkbox" id="checkExercise" class="form-checkbox h-5 w-5 text-teal-600 rounded focus:ring-teal-500">
                    </div>
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <label for="checkScreen" class="text-sm font-medium text-gray-700 flex-1">ì·¨ì¹¨ 1ì‹œê°„ ì „ ìŠ¤ë§ˆíŠ¸í°/TV X</label>
                        <input type="checkbox" id="checkScreen" class="form-checkbox h-5 w-5 text-teal-600 rounded focus:ring-teal-500">
                    </div>
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <label for="checkMeal" class="text-sm font-medium text-gray-700 flex-1">ì·¨ì¹¨ 2ì‹œê°„ ì „ ê³¼ì‹ X</label>
                        <input type="checkbox" id="checkMeal" class="form-checkbox h-5 w-5 text-teal-600 rounded focus:ring-teal-500">
                    </div>
                </div>

                <button onclick="logHygiene()" class="mt-4 w-full bg-teal-600 text-white py-2 rounded-lg font-semibold hover:bg-teal-700 transition duration-150 shadow-lg shadow-teal-200/50">
                    ì˜¤ëŠ˜ì˜ ìŠµê´€ ì €ì¥í•˜ê¸°
                </button>
                <div id="hygieneMessage" class="mt-2 text-sm text-center font-medium"></div>
            </div>

            <!-- ìˆ˜ë©´ í†µê³„ ë° ë¦´ë™ìŠ¤ ê¸°ëŠ¥ (ê¸°ì¡´ ì¡°ê±´ 3) -->
            <div class="section-card">
                <h2 class="text-2xl font-bold text-purple-700 mb-4">3. í†µê³„, ì‚¬ìš´ë“œ ë° ë¦´ë™ìŠ¤ ê¸°ëŠ¥</h2>

                <!-- ìˆ˜ë©´ í†µê³„ (Hygiene Scoreë¡œ ë³€ê²½) -->
                <h3 class="text-xl font-semibold text-purple-600 mb-2 border-b pb-1">ë‚˜ì˜ ìˆ˜ë©´ ìœ„ìƒ ì ìˆ˜</h3>
                <div id="statsDisplay" class="p-3 bg-purple-50 rounded-lg text-purple-800 font-medium text-sm space-y-2">
                    <p>í‰ê·  ìœ„ìƒ ì ìˆ˜: <span id="avgHygieneScore">--</span></p>
                    <p>ìµœê·¼ 7ì¼ ì—°ì† ì„±ê³µ: <span id="streakCount">--</span></p>
                    <p class="text-xs text-purple-500 mt-2">ìµœëŒ€ 10ê°œ ê¸°ë¡ ê¸°ì¤€</p>
                </div>
                <button onclick="loadHygieneRecordsAndStats()" class="mt-2 w-full bg-purple-500 text-white py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-150 text-sm">
                    ìµœì‹  ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
                </button>

                <hr class="my-6">

                <!-- í˜¸í¡ ê°€ì´ë“œ (ê¸°ì¡´ ì¡°ê±´ 3) -->
                <h3 class="text-xl font-semibold text-purple-600 mb-2 border-b pb-1">í˜¸í¡ ë¦´ë™ìŠ¤ ê°€ì´ë“œ (4-7-8)</h3>
                <div class="text-center">
                    <div class="breathing-circle" id="breathingCircle"></div>
                    <div id="breathingInstruction" class="text-lg font-semibold text-gray-700 my-2">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                    <button id="breathingButton" onclick="toggleBreathingGuide()" class="bg-gray-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-150 shadow-lg">
                        ì‹œì‘
                    </button>
                </div>
                
                <hr class="my-6">

                <!-- ìˆ˜ë©´ ìœ ë„ ì‚¬ìš´ë“œ (NEW ì¶”ê°€ ê¸°ëŠ¥) -->
                <h3 class="text-xl font-semibold text-pink-600 mb-2 border-b pb-1">ìˆ˜ë©´ ìœ ë„ ì‚¬ìš´ë“œ (ë°±ìƒ‰ ì†ŒìŒ)</h3>
                <div class="text-center">
                    <p id="soundStatus" class="text-sm text-gray-700 mb-3">ì†Œë¦¬ê°€ ì¬ìƒë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <button id="soundButton" onclick="toggleSleepSound()" class="bg-pink-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-pink-600 transition duration-150 shadow-lg">
                        ë°±ìƒ‰ ì†ŒìŒ ì¬ìƒ
                    </button>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ë©´ ê¸°ë¡ ëª©ë¡ (Hygiene Recordë¡œ ë³€ê²½) -->
        <div class="section-card mt-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">4. ìµœê·¼ ìœ„ìƒ ìŠµê´€ ê¸°ë¡</h2>
            <div id="recordsList" class="space-y-3">
                <p class="text-gray-500">ê¸°ë¡ëœ ìœ„ìƒ ìŠµê´€ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, addDoc, setDoc, getDoc, getDocs, onSnapshot, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ê¸€ë¡œë²Œ ë³€ìˆ˜ ì„¤ì •
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        setLogLevel('Debug');

        /**
         * Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    document.getElementById('authStatus').textContent = "âš ï¸ Firebase ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                document.getElementById('authStatus').textContent = "ì‚¬ìš©ì ì¸ì¦ ì¤‘...";

                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('authStatus').textContent = `âœ… ì¸ì¦ ì™„ë£Œ. ì‚¬ìš©ì ID: ${userId.substring(0, 8)}...`;
                        isAuthReady = true;
                        window.db = db;
                        window.auth = auth;
                        window.userId = userId;
                        window.loadHygieneRecordsAndStats(); // ì¸ì¦ í›„ ë°ì´í„° ë¡œë“œ
                        window.loadDailyHygiene(); // ì˜¤ëŠ˜ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                    } else {
                        userId = null;
                        document.getElementById('authStatus').textContent = "âš ï¸ ì¸ì¦ ì‹¤íŒ¨. ìµëª… ë¡œê·¸ì¸ ì‹œë„ ì¤‘...";
                    }
                });

                // ì‚¬ìš©ì ì •ì˜ í† í° ë˜ëŠ” ìµëª… ë¡œê·¸ì¸ ì‹œë„
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                document.getElementById('authStatus').textContent = `âŒ ì¸ì¦ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        /**
         * REM ìˆ˜ë©´ ì£¼ê¸°ì— ë§ì¶° ìµœì ì˜ ìˆ˜ë©´/ê¸°ìƒ ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ ì¡°ê±´ 1)
         * REM ìˆ˜ë©´ ì£¼ê¸°: 90ë¶„, ì ë“œëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„: 14ë¶„ (í‰ê· )
         */
        window.calculateSleepCycles = function() {
            const calcTimeInput = document.getElementById('calcTime');
            const calcTypeInput = document.getElementById('calcType');
            const resultDiv = document.getElementById('calcResult');

            const timeValue = calcTimeInput.value;
            const typeValue = calcTypeInput.value;

            if (!timeValue) {
                resultDiv.textContent = "ì‹œê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                return;
            }

            const now = new Date();
            const [hours, minutes] = timeValue.split(':').map(Number);

            let targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);

            // ì˜¤ëŠ˜ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë©´ ë‚´ì¼ ì‹œê°„ìœ¼ë¡œ ê°„ì£¼
            if (targetTime < now) {
                targetTime.setDate(targetTime.getDate() + 1);
            }

            const timeToFallAsleep = 14; // ë¶„
            const sleepCycle = 90; // ë¶„
            const cycles = [6, 5, 4, 3]; // ê¶Œì¥ ìˆ˜ë©´ ì‚¬ì´í´

            let suggestions = [];

            cycles.forEach(numCycles => {
                let calculatedTime;
                let description;

                if (typeValue === 'wake') {
                    // ê¸°ìƒ ì‹œê°„ ê¸°ì¤€: ì ë“œëŠ” ì‹œê°„ ê³„ì‚°
                    const totalSleepMinutes = (numCycles * sleepCycle) + timeToFallAsleep;
                    calculatedTime = new Date(targetTime.getTime() - totalSleepMinutes * 60000);
                    description = `(ê¶Œì¥ ìˆ˜ë©´ ${numCycles} ì£¼ê¸°)`;
                } else {
                    // ì·¨ì¹¨ ì‹œê°„ ê¸°ì¤€: ê¸°ìƒ ì‹œê°„ ê³„ì‚°
                    const totalSleepMinutes = (numCycles * sleepCycle) + timeToFallAsleep;
                    calculatedTime = new Date(targetTime.getTime() + totalSleepMinutes * 60000);
                    description = `(ê¶Œì¥ ìˆ˜ë©´ ${numCycles} ì£¼ê¸°)`;
                }

                // ì‹œê°„ í¬ë§· (HH:MM AM/PM)
                const formattedTime = calculatedTime.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                
                suggestions.push({
                    time: formattedTime,
                    description: description,
                    date: calculatedTime.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' })
                });
            });

            let html = `<p class="font-bold mb-2">ìµœì ì˜ ìˆ˜ë©´ ì‹œê°„ ì œì•ˆ:</p>`;
            
            if (typeValue === 'wake') {
                html += `<p class="text-sm">ì…ë ¥ëœ ê¸°ìƒ ì‹œê°„: <strong>${timeValue}</strong></p>`;
                html += `<ul class="list-disc list-inside mt-2 space-y-1">`;
                suggestions.forEach(s => {
                    html += `<li><strong>${s.time}</strong> (${s.date})ì— ì ë“œì‹œë©´ ${s.description} í›„ ê°€ì¥ ê°œìš´í•˜ê²Œ ì¼ì–´ë‚˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>`;
                });
                html += `</ul>`;
            } else {
                html += `<p class="text-sm">ì…ë ¥ëœ ì·¨ì¹¨ ì‹œê°„: <strong>${timeValue}</strong></p>`;
                html += `<ul class="list-disc list-inside mt-2 space-y-1">`;
                suggestions.forEach(s => {
                    html += `<li><strong>${s.time}</strong> (${s.date})ì— ì¼ì–´ë‚˜ì‹œë©´ ${s.description} í›„ ê°€ì¥ ê°œìš´í•˜ê²Œ ì¼ì–´ë‚˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>`;
                });
                html += `</ul>`;
            }
            
            html += `<p class="mt-3 text-xs text-gray-600">âš  ë³¸ ê³„ì‚°ì€ í‰ê· ì¹˜(ì ë“œëŠ” ì‹œê°„ 14ë¶„, ìˆ˜ë©´ ì£¼ê¸° 90ë¶„)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤. ê°œì¸ì°¨ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
            resultDiv.innerHTML = html;
        }


        /**
         * ìˆ˜ë©´ ìœ„ìƒ ìŠµê´€ì„ Firebase Firestoreì— ì €ì¥í•©ë‹ˆë‹¤. (New Feature)
         */
        window.logHygiene = async function() {
            if (!isAuthReady || !db || !userId) {
                alertModal("ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "ì˜¤ë¥˜");
                return;
            }

            const logMessage = document.getElementById('hygieneMessage');
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD (ë¬¸ì„œ IDë¡œ ì‚¬ìš©)

            const hygieneData = {
                caffeine: document.getElementById('checkCaffeine').checked,
                exercise: document.getElementById('checkExercise').checked,
                screen: document.getElementById('checkScreen').checked,
                meal: document.getElementById('checkMeal').checked,
                score: [
                    document.getElementById('checkCaffeine').checked,
                    document.getElementById('checkExercise').checked,
                    document.getElementById('checkScreen').checked,
                    document.getElementById('checkMeal').checked
                ].filter(Boolean).length, // 4ì  ë§Œì 
                loggedDate: today,
                loggedAt: serverTimestamp()
            };

            logMessage.className = 'mt-2 text-sm text-center font-medium text-blue-500';
            logMessage.textContent = "ê¸°ë¡ ì €ì¥ ì¤‘...";

            try {
                // setDocì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„œ IDë¥¼ ë‚ ì§œ(today)ë¡œ ê³ ì •í•˜ì—¬ ë®ì–´ì“°ê¸° (Upsert)
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/hygiene_records`, today);
                await setDoc(docRef, hygieneData);

                logMessage.className = 'mt-2 text-sm text-center font-medium text-green-500';
                logMessage.textContent = `âœ… ${today}ì˜ ìˆ˜ë©´ ìŠµê´€ ê¸°ë¡ ì™„ë£Œ! (ì ìˆ˜: ${hygieneData.score}ì )`;

                loadHygieneRecordsAndStats(); // í†µê³„ ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (e) {
                console.error("Firestoreì— ìœ„ìƒ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:", e);
                logMessage.className = 'mt-2 text-sm text-center font-medium text-red-500';
                logMessage.textContent = `âŒ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ${e.message}`;
            }
        }
        
        /**
         * ì˜¤ëŠ˜ ì €ì¥ëœ ìœ„ìƒ ê¸°ë¡ì´ ìˆë‹¤ë©´ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
         */
        window.loadDailyHygiene = async function() {
            if (!isAuthReady || !db || !userId) return;

            const today = new Date().toISOString().slice(0, 10);
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/hygiene_records`, today);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('checkCaffeine').checked = data.caffeine || false;
                    document.getElementById('checkExercise').checked = data.exercise || false;
                    document.getElementById('checkScreen').checked = data.screen || false;
                    document.getElementById('checkMeal').checked = data.meal || false;
                    document.getElementById('hygieneMessage').className = 'mt-2 text-sm text-center font-medium text-gray-500';
                    document.getElementById('hygieneMessage').textContent = `ğŸ—“ï¸ ${today} ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ì ìˆ˜: ${data.score}ì )`;
                } else {
                    // ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                    document.getElementById('checkCaffeine').checked = false;
                    document.getElementById('checkExercise').checked = false;
                    document.getElementById('checkScreen').checked = false;
                    document.getElementById('checkMeal').checked = false;
                    document.getElementById('hygieneMessage').textContent = `ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.`;
                }
            } catch (e) {
                console.error("ì˜¤ëŠ˜ì˜ ìœ„ìƒ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
            }
        }


        /**
         * ìœ„ìƒ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™€ í†µê³„ë¥¼ ê³„ì‚°í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. (ìˆ˜ë©´ í’ˆì§ˆ/ì‹œê°„ ê¸°ë¡ ëŒ€ì‹  ì‚¬ìš©)
         */
        window.loadHygieneRecordsAndStats = async function() {
            if (!isAuthReady || !db || !userId) {
                document.getElementById('avgHygieneScore').textContent = 'ì¸ì¦ ëŒ€ê¸° ì¤‘...';
                document.getElementById('streakCount').textContent = 'ì¸ì¦ ëŒ€ê¸° ì¤‘...';
                return;
            }
            
            const statsDisplay = document.getElementById('statsDisplay');
            statsDisplay.innerHTML = `<p class="text-center">ë°ì´í„° ë¡œë“œ ì¤‘...</p>`;
            
            const recordsList = document.getElementById('recordsList');
            recordsList.innerHTML = '';
            
            try {
                const recordsColRef = collection(db, `artifacts/${appId}/users/${userId}/hygiene_records`);
                
                const q = query(recordsColRef);
                const querySnapshot = await getDocs(q);

                let totalScore = 0;
                let records = [];
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    records.push(data);
                });

                // ë‚ ì§œ(loggedDate) ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                records.sort((a, b) => (b.loggedDate || '').localeCompare(a.loggedDate || ''));
                
                const latestRecords = records.slice(0, 10);
                
                // í†µê³„ ê³„ì‚°
                latestRecords.forEach(data => {
                    totalScore += data.score || 0;
                });

                const count = latestRecords.length;
                
                if (count === 0) {
                    statsDisplay.innerHTML = `<p>ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    recordsList.innerHTML = `<p class="text-gray-500">ê¸°ë¡ëœ ìœ„ìƒ ìŠµê´€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                const avgScore = totalScore / count;
                
                // ì—°ì† ê¸°ë¡ (Streak) ê³„ì‚°: ìµœê·¼ 7ì¼ ì¤‘ ë§Œì (4ì ) ê¸°ë¡ ìˆ˜ ê³„ì‚°
                let streak = 0;
                const todayStr = new Date().toISOString().slice(0, 10);
                const recentDates = [];
                
                for (let i = 0; i < 7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    recentDates.push(d.toISOString().slice(0, 10));
                }
                
                const recentScores = records.filter(r => recentDates.includes(r.loggedDate));
                recentScores.sort((a, b) => b.loggedDate.localeCompare(a.loggedDate)); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

                // ì—°ì†ëœ ë‚ ì§œì— 4ì ì¸ì§€ í™•ì¸
                let tempStreak = 0;
                for (const date of recentDates) {
                    const record = recentScores.find(r => r.loggedDate === date);
                    if (record && record.score === 4) {
                        tempStreak++;
                    } else if (record && record.score !== 4) {
                        // ë§Œì  ì‹¤íŒ¨ ì‹œ ì—°ì† ê¸°ë¡ ëŠê¹€ (ë§Œì ì„ ì—°ì† ì„±ê³µ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •)
                        tempStreak = 0;
                    } else if (date < todayStr) {
                         // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œì— ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì—°ì† ê¸°ë¡ ëŠê¹€
                        break; 
                    }
                    streak = Math.max(streak, tempStreak);
                }
                

                statsDisplay.innerHTML = `
                    <p>í‰ê·  ìœ„ìƒ ì ìˆ˜: <span id="avgHygieneScore" class="font-bold text-lg text-purple-700">${avgScore.toFixed(2)} / 4 ì </span></p>
                    <p>ì—°ì† ë§Œì  ê¸°ë¡: <span id="streakCount" class="font-bold text-lg text-purple-700">${streak} ì¼</span></p>
                    <p class="text-xs text-purple-500 mt-2">ìµœì‹  ${count}ê°œ ê¸°ë¡ ê¸°ì¤€ (4ì  ë§Œì )</p>
                `;

                // ê¸°ë¡ ëª©ë¡ í‘œì‹œ
                let listHtml = '';
                latestRecords.forEach((data, index) => {
                    const score = data.score || 0;
                    const scoreEmoji = score === 4 ? 'â­ï¸' : score >= 2 ? 'ğŸ‘' : 'ğŸ¤”';
                    const scoreColor = score === 4 ? 'bg-green-100 text-green-800' : 
                                         score >= 2 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';

                    listHtml += `
                        <div class="p-3 bg-white border border-gray-200 rounded-lg flex justify-between items-center shadow-sm">
                            <div>
                                <p class="text-sm font-semibold">${data.loggedDate} ìœ„ìƒ</p>
                                <p class="text-xs text-gray-600">
                                    ì¹´í˜ì¸: ${data.caffeine ? 'O' : 'X'} | 
                                    ìš´ë™: ${data.exercise ? 'O' : 'X'} | 
                                    ìŠ¤í¬ë¦°: ${data.screen ? 'O' : 'X'} | 
                                    ê³¼ì‹: ${data.meal ? 'O' : 'X'}
                                </p>
                            </div>
                            <span class="px-2 py-0.5 rounded-full text-xs font-bold ${scoreColor}">${scoreEmoji} ${score} / 4</span>
                        </div>
                    `;
                });
                recordsList.innerHTML = listHtml;


            } catch (e) {
                console.error("ìœ„ìƒ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
                statsDisplay.innerHTML = `<p class="text-red-500">ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
            }
        }
        
        // --- í˜¸í¡ ê°€ì´ë“œ ê¸°ëŠ¥ (ê¸°ì¡´ ì¡°ê±´ 3) ---
        let breathingInterval = null;
        let isBreathing = false;
        const breathingCircle = document.getElementById('breathingCircle');
        const breathingInstruction = document.getElementById('breathingInstruction');
        const breathingButton = document.getElementById('breathingButton');
        const instructionMap = [
            { text: "ë“¤ì´ë§ˆì‹œê¸° (4ì´ˆ)", duration: 4000, next: 1, action: "scale(1.2)" },
            { text: "ì°¸ê¸° (7ì´ˆ)", duration: 7000, next: 2, action: "scale(1.15)" },
            { text: "ë‚´ì‰¬ê¸° (8ì´ˆ)", duration: 8000, next: 0, action: "scale(1)" }
        ];

        window.toggleBreathingGuide = function() {
            if (isBreathing) {
                stopBreathingGuide();
            } else {
                startBreathingGuide();
            }
        }

        function startBreathingGuide() {
            if (isBreathing) return;
            isBreathing = true;
            breathingButton.textContent = "ì¤‘ì§€";
            breathingButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            breathingButton.classList.add('bg-red-500', 'hover:bg-red-600');
            breathingCircle.classList.add('breathing');
            
            let step = 0;
            
            // ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
            breathingInstruction.textContent = instructionMap[0].text;
            
            function cycle() {
                const current = instructionMap[step];
                breathingInstruction.textContent = current.text;
                step = current.next;
                
                if (isBreathing) {
                    breathingInterval = setTimeout(cycle, current.duration);
                }
            }
            
            // ì „ì²´ 19ì´ˆ ì£¼ê¸°ì— ë§ì¶° CSS ì• ë‹ˆë©”ì´ì…˜ì„ ì‚¬ìš©í•˜ê³ , í…ìŠ¤íŠ¸ëŠ” ë§¤ ë‹¨ê³„ë§ˆë‹¤ ë³€ê²½
            breathingInterval = setTimeout(cycle, instructionMap[0].duration); // ì²« ë‹¨ê³„ í›„ ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘
        }

        function stopBreathingGuide() {
            isBreathing = false;
            if (breathingInterval) {
                clearTimeout(breathingInterval);
            }
            breathingButton.textContent = "ì‹œì‘";
            breathingButton.classList.remove('bg-red-500', 'hover:bg-red-600');
            breathingButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
            breathingCircle.classList.remove('breathing');
            breathingInstruction.textContent = "ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            breathingCircle.style.transform = 'scale(1)';
        }

        // --- ìˆ˜ë©´ ìœ ë„ ì‚¬ìš´ë“œ ê¸°ëŠ¥ (New Feature) ---
        let audioContext = null;
        let noiseSource = null;

        window.toggleSleepSound = function() {
            const button = document.getElementById('soundButton');
            const status = document.getElementById('soundStatus');

            try {
                if (noiseSource) {
                    // Stop
                    noiseSource.stop();
                    noiseSource = null;
                    button.textContent = "ë°±ìƒ‰ ì†ŒìŒ ì¬ìƒ";
                    status.textContent = "ì†Œë¦¬ê°€ ì¬ìƒë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.";
                    button.classList.remove('bg-red-500', 'hover:bg-red-600');
                    button.classList.add('bg-pink-500', 'hover:bg-pink-600');
                } else {
                    // Start
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // ë°±ìƒ‰ ì†ŒìŒ ìƒì„±
                    noiseSource = audioContext.createBufferSource();
                    const bufferSize = 2 * audioContext.sampleRate;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const output = buffer.getChannelData(0);

                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1; // -1.0ì—ì„œ 1.0 ì‚¬ì´ì˜ ëœë¤ ë…¸ì´ì¦ˆ
                    }

                    noiseSource.buffer = buffer;
                    noiseSource.loop = true;

                    // ë³¼ë¥¨ ì¡°ì ˆ (ë„ˆë¬´ ì‹œë„ëŸ½ì§€ ì•Šë„ë¡)
                    const gainNode = audioContext.createGain();
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime); // 20% ë³¼ë¥¨
                    
                    noiseSource.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    noiseSource.start();

                    button.textContent = "ì†Œë¦¬ ë„ê¸°";
                    status.textContent = "ğŸ”Š ë°±ìƒ‰ ì†ŒìŒì´ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤. (ê¸°ê¸° ë³¼ë¥¨ ì¡°ì ˆ í•„ìš”)";
                    button.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                    button.classList.add('bg-red-500', 'hover:bg-red-600');
                }
            } catch (error) {
                console.error("Sleep Sound Error:", error);
                alertModal(`ì˜¤ë¥˜: ì†Œë¦¬ ì¬ìƒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (${error.message})`, "ì‚¬ìš´ë“œ ì˜¤ë¥˜");
                if (noiseSource) noiseSource.stop();
                noiseSource = null;
                button.textContent = "ë°±ìƒ‰ ì†ŒìŒ ì¬ìƒ";
                status.textContent = "ì†Œë¦¬ê°€ ì¬ìƒë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.";
                button.classList.remove('bg-red-500', 'hover:bg-red-600');
                button.classList.add('bg-pink-500', 'hover:bg-pink-600');
            }
        }

        // --- ìœ í‹¸ë¦¬í‹° ë° ì´ˆê¸°í™” ---

        function alertModal(message, title = "ì•Œë¦¼") {
            const existingModal = document.getElementById('customAlert');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="customAlert" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 transform transition-all">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="document.getElementById('customAlert').remove()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">í™•ì¸</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alertModal = alertModal;
        window.loadSleepRecords = window.loadHygieneRecordsAndStats; // ì´ì „ í•¨ìˆ˜ ì´ë¦„ ì°¸ì¡°ë¥¼ ìƒˆ í•¨ìˆ˜ë¡œ ì—°ê²°

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™”
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>
